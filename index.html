<!DOCTYPE html>
<html>
  <head>
    <title>Borg Documentation</title>
    <link rel="stylesheet" href="stylesheets/global.css">
  </head>
  <body>
    <div id="content">
      <nav>
        <div class="wrapper">
          <h1 class="logo">Borg Documentation</h1>
          <ul class="right">
            <li><a href="https://github.com/mikesmullin/borg">Github</a></li>
            <li class="toc"><a href="index.html#">Docs</a></li>
            <li><a href="index.html#">Contribute</a></li>
            <li><a href="index.html#">Credits</a></li>
          </ul>
          <div class="clear"></div>
        </div>
      </nav>
      <header>
        <div class="wrapper">
          <h2>Borg Documentation (v0.0.1)</h2>
          <p>This information is designed to make you immediately productive with <strong><a href="https://www.npmjs.com/package/borg">Borg v0.0.4</a></strong>.<br>When additional versions are released, previous versions will be linked here.<br>Let&rsquo;s get started!</p>
        </div>
      </header>
      <article>
        <div class="wrapper">
          <h2 id="getting-started">1. Getting Started</h2>
          <h3 id="install-node.js">1.1. Install Node.JS</h3>
          <p>Using <a href="https://github.com/creationix/nvm">NVM </a> to install <a href="http://nodejs.org">Node.JS</a> is recommended.</p>
          <pre><code>curl https://raw.github.com/creationix/nvm/master/install.sh | sh
nvm install v0.10.28 # latest stable preferred
nvm use v0.10.28
nvm alias default v0.10.28</code></pre>
          <h3 id="install-borg">1.2. Install Borg</h3>
          <pre><code>npm install borg -g</code></pre>
          <h3 id="generate-a-new-project">1.3. Generate a New Project</h3>
          <pre><code>borg init Devops
cd Devops/</code></pre>
          <p>Or, clone an <a href="https://github.com/mikesmullin/borg-sample-project">existing</a> one.</p>
          <h3 id="explore-help">1.4. Explore Help</h3>
          <pre><code>borg help</code></pre>
          <h2 id="cloud-integration">2. Cloud Integration</h2>
          <p>
            Though abstracted to integrate with any cloud provider,
            only <a href="http://aws.amazon.com/">Amazon Web Services</a> integration is implemented at present.
          </p>
          <h3 id="amazon-web-services">2.1. Amazon Web Services</h3>
          <p>This integration depends on the AWS CLI utility being installed:</p>
          <pre><code>cd /tmp
wget https://s3.amazonaws.com/aws-cli/awscli-bundle.zip
unzip awscli-bundle.zip
sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
aws --version # test</code></pre>
          <p>and configured:</p>
          <pre><code>aws configure
Access Key ID: your-aws-access-key-id
Secret Access Key: your-aws-secret-key</code></pre>
          <p>For more information, please see:<br><a href="http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ec2-cli-linux.html">Setting Up the Amazon EC2 Command Line Interface Tools</a></p>
          <h2 id="introduction">3. Introduction</h2>
          <h3 id="vernacular">3.1. Vernacular</h3>
          <ul>
            <li><strong>script: </strong>file containing code listing steps to complete orchestration.<br><br></li>
            <li> <strong>resource: </strong>named function organizing common steps for reuse across multiple scripts; often with the secondary goal of becoming os agnostic.<br><br></li>
            <li> <strong>server: </strong>file containing code defining how remote machines are named and addressed, and which scripts must be applied in order to complete their orchestration.<br><br></li>
            <li> <strong>attribute: </strong>server variable; representing static data, dynamic runtime calculation functions, or personal preferences/overrides for use by scripts at runtime.<br><br></li>
            <li> <strong>networks.coffee: </strong>file containing a list of servers and their attributes--as well as the relationship of one server to another in a hierarchy of datacenters, groups, server types, and server instances.<br><br></li>
            <li> <strong>datacenter: </strong>the outermost unit available for the grouping of reusable server definitions (e.g., one datacenter may contain two or more instances of the same server)<br><br></li>
            <li> <strong>group: </strong>another unit available for the grouping of servers; typically named after the environment and project (e.g., a datacenter may contain a group for the production environment of project A as well as the staging environment for project B, both of which contain separate instances of the same type of server)<br><br></li>
            <li> <strong>borg create: </strong>to provision a new empty remote server via cloud provider apis.<br><br></li>
            <li> <strong>borg assimilate: </strong>to orchestrate a remote server.<br><br></li>
            <li> <strong>borg assemble: </strong>to both <code>create</code> and then <code>assimilate</code>.<br><br></li>
          </ul>
          <h3 id="directory-structure">3.2. Directory structure</h3>
          <pre><code>attributes/		JSON and CSON files; see <a href="index.html#attributes">Attributes</a> chapter below
  networks.coffee	your datacenter and server hierarchy
  memory.json		remembers details from cloud provider api interactions
scripts/		your Scripts; see <a href="index.html#scripts">Scripts</a> chapter below
  server/		code defining which Servers use which Scripts
  vendor/		third-party Scripts as Git submodules</code></pre>
          <h2 id="attributes">4. Attributes</h2>
          <p>Attribute files are regular <a href="http://coffeescript.org">CoffeeScript</a> files, appropriately suffixed <code>.coffee</code>, but some of them might more effectively thought of as <strong>CoffeeScript Object Notation (<a href="https://github.com/bevry/cson">CSON</a>)</strong>; a variation of <a href="http://www.json.org/">JSON</a> that allows you to, among other things, make use of <a href="http://coffeescript.org/#strings">comments</a>, <a href="http://coffeescript.org/#strings">string interpolation</a>, <a href="http://coffeescript.org/#literals">function values</a>, and conditional logic such as <a href="http://coffeescript.org/#conditionals">ternary</a> and <a href="http://coffeescript.org/#switch">switch statements</a>. This features make it a more versatile alternative to <a href="http://www.yaml.org/">YAML</a>.</p>
          <p>
            It is recommended to take advantage of these features to achieve,
            as close as possible, the overall goal of <strong><a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> (Don’t Repeat Yourself)</strong> and readability. Strive to simplify the job of an
            application maintainer who will only want to look in a single place
            to change any attribute value generated by the devops scripts.
          </p>
          <p>
            There are times when it is appropriate for an attribute to be 
            defined in more than one place. Borg knows which value to use 
            in these cases because it merges attribute files in a specific 
            order at runtime. For example, your attribute definitions will 
            override any defaults provided by third-party submodules. 
          </p>
          <p>
            The resulting attribute values are accessible to all scripts 
            from within the <code>@server</code> variable, which is also pretty printed 
            to the debug log at the beginning of each run.
          </p>
          <h3 id="attribute-precedence">4.1. Attribute Precedence</h3>
          <p>
            Although it may seem straightforward, when making changes its 
            important to be sure any changes to attribute values won’t be 
            accidentally overridden. To help illustrate both the various 
            locations where attributes can be defined, and the order that 
            they get merged to produce the final result, we’ve assembled 
            the handy chart below, in order of precedence:
          </p>
          <table>
            <thead>
              <tr>
                <th>Name, Location, Precendence</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <p><strong>1. Hard-coded</strong><br>scripts/*/*.coffee<br>scripts/*/templates/*/*.coffee<br><em>(un-overridable precedence)</em></p>
                  <p>
                    Always scrutinize whether there are values in
                    your scripts which would be more useful as attributes
                    that others can see and modify.
                  </p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define local variables which remain
                    private to only one script and its templates.
                  </p>
                  <p>
                    Calculations, for example, may be based on a combination
                    of attributes defined elsewhere--such as in a
                    concatenation operation, or a hashing operation, or any
                    kind of last-minute reformatting.
                  </p>
                  <p><strong>Convention:</strong><br>Defining constants or overriding attributes within the
                    template code itself is discouraged, because its
                    difficult for other users to change these and remain
                    compatible with your upstream. The only exception is
                    when a script author is certain the resulting output is
                    unlikely to be a desired change.
                  </p>
                  <p>
                    As it happens, most scripts end up 100% hard-coded as
                    a convenience for authors in a hurry to get testing and building
                    servers. However, these aren't useful for sharing publicly
                    until all values are abstracted as overridable attributes.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>2. CLI <code>--locals=</code> Attributes</strong><br>Process arg w/ CSON value<br><em>(high precedence)</em></p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define short-term instance attribute values unique to this run.</p>
                  <p><strong>Convention:</strong><br>Commonly these are one-time values that are expected to change
                    by the end of a successful run.
                  </p>
                  <p>
                    For example, if a script was expected to change the sshd listen
                    port, but aborted due to an  error before that step was reached,
                    you may want to override that setting temporarily until you are
                    done debugging and retrying.<br>(e.g., <code>ssh: port:</code>, <code>user:</code>, <code>pass:</code>, <code>key:</code>)
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>3. Global Attributes</strong><br>attributes/networks.coffee<br>in the <code>global:</code> key</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define long-term instance attribute default values in the most general way possible.</p>
                  <p><strong>Convention:</strong><br>Rarely useful for global user preferences.<br>(e.g., <code>ssh: port</code> or <code>tz:</code>)</p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>4. Datacenter Attributes</strong><br>attributes/networks.coffee<br>in the <code>datacenters:</code> key</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define long-term attribute values per-datacenter,
                    per-environment, per-group, per-type, and/or per-instance.
                  </p>
                  <p><strong>Convention:</strong><br>Perhaps the most commonly used area to specify attributes
                    of any.
                  </p>
                  <p>
                    Details information specific to an instance, such as 
                    the AWS AMI, instance size, region id, zone, security group,
                    as well as information used by scripts, such as
                    memory settings, the number of instances to create in
                    each datacenter, and how they are grouped. (e.g., by environment)
                  </p>
                  <p>
                    Also provides individual scripts with hierarchical graph of
                    all defined systems in the local and extended network,
                    represented by the <code>@networks</code> variable, which is intended to be useful when dynamically
                    configuring firewall, monitoring, whitelists or other lists
                    that need to access relational information about servers other
                    than the one currently assimliating.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>5. Server Attributes</strong><br>scripts/servers/*.coffee<br>within the exported function <code>assimilate: -></code></p>
                  <p>
                    Usually there is at least one of these files for each type
                    of server.
                  </p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Default attributes unique to servers of one type.</p>
                  <p>
                    These files also define the order that scripts are 
                    executed to complete assimilation of the machine.
                  </p>
                  <p><strong>Convention:</strong><br>For example, a set of attribute values shared by servers 
                    "web01", "web02", ... "web09"
                    could all be defined once in a file called <code>scripts/servers/web.coffee</code>
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>6. Script Attributes</strong><br>scripts/*/attributes/*/*.coffee</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>The most appropriate place for a script author to declare
                    all script attributes and set default values which can
                    be later overridden, because it is packaged together with
                    the script when shared.
                  </p>
                  <p>
                    Also the best place to look first for a list of attributes
                    you can override if you are a new user of a third-party
                    script.
                  </p>
                  <p><strong>Convention:</strong><br>It is recommended to define defaults for all script
                    attributes so the user only has to define overriding values
                    to address unusual cases.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong>7. Memory Attributes</strong><br>attributes/memory.json<br><em>(lowest precedence)</em></p>
                  <p>Users should avoid modifying this file directly.</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Data remembered by Borg after successfully interacting with 
                    the cloud provider API.
                  </p>
                  <p><strong>Convention:</strong><br>Great for things you don’t want to have to constantly insert
                    into an attribute file manually; things Borg can figure out
                    on its own, or that can only be figured out during/after a
                    run.
                  </p>
                  <p>
                    These are commonly used when automatically 
                    connecting to a newly made server, or deleting an existing 
                    server.<br>(e.g., <code>@server.instance_id</code>, <code>@server.public_ip</code>)
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
          <h3 id="cascading-attributes">4.2. Cascading Attributes</h3>
          <p>This next section applies specifically only to the <code>./attributes/networks.coffee</code> file. The goal with this file is to create an object hierarchy like: <code>datacenters: D1: groups: G1: servers: S1: instances: I1: PROPERTY: VALUE</code> where ALL-CAPS keys are names you would invent.
            This hierarchy of <strong>cascading attributes</strong> (like <a href="https://developer.mozilla.org/en-US/docs/Web/CSS">cascading style sheets</a>)
            allow the most generic definitions at the root (least <a href="http://www.smashingmagazine.com/2007/07/27/css-specificity-things-you-should-know/">specificity</a>)
            to be inherited all the way down to the most specific definitions in
            the deepest leaves (most specificity; in this case, <code>I1</code>) to define the network.
          </p>
          <p>
            Observe how the keys are then inherited by instances 
            through a <a href="https://lodash.com/docs#merge"><code>_.merge()</code></a> to create the final fully-detailed 
            instance-level leaves a.k.a. the final object representing all 
            the keys attributed to a specific server instance. In order of 
            objects merged; latter overrides former.
          </p>
          <ol>
            <li><code>global.*</code></li>
            <li><code>datacenters.*.*</code> (except key: <code>groups</code>)</li>
            <li><code>datacenters.*.groups.*.*</code> (except key: <code>servers</code>)</li>
            <li><code>datacenters.*.groups.*.servers.*.*</code> (except key: <code>instances</code>)</li>
            <li><code>datacenters.*.groups.*.servers.*.instances.*.*</code></li>
          </ol>
          <h3 id="@networks-object">4.3. @networks object</h3>
          <p><strong>A <code>networks.coffee</code> structure like:</strong></p>
          <pre><code>global:
  ssh_port: 3562
datacenters:
  aws-ca:
    provider: 'aws'
    groups:
      'prod-myproject':
         env: 'prod'
         tld: '.myproject.tld'
         servers:
           'myapp':
             aws_size: 't2.micro'
             instances:
               '01':
                 aws_size: 'm3.xlarge'
                 secondary_ip: '1.2.3.4'
               '02':
                 secondary_ip: '1.2.3.5'</code></pre>
          <p><strong>Will be merged into a <code>@networks</code> object, in scope from within scripts:</strong></p>
          <pre><code>@networks.datacenters['aws-ca'].groups['prod-myproject'].servers['my-app'].instances['01'] =
  aws_size: 'm3.xlarge'
  secondary_ip: '1.2.3.4'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562
@networks.datacenters['aws-ca'].groups['prod-myproject'].servers['my-app'].instances['02'] =
  aws_size: 't2.micro'
  secondary_ip: '1.2.3.5'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562</code></pre>
          <p>
            So our script can now reach attributes for all servers, and it can
            lookup attributes by their relationship to other servers in the
            network hierarchy. (e.g., what is the secondary_ip of each my-app
            server in the same datacenter and group as the current server?)
          </p>
          <h3 id="@server-object">4.4. @server object</h3>
          <p>
            But there is also a shortcut to the current server’s attributes--
            which in the above case, if we pretend the current server is my-app02, 
            would be:
          </p>
          <pre><code>@server =
  aws_size: 't2.micro'
  secondary_ip: '1.2.3.5'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562</code></pre>
          <h3 id="attribute-functions">4.5. Attribute Functions</h3>
          <p>
            Notice you can define function values which are [re-]evaluated
            (as a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">javascript getter</a>)
            at runtime every time they are referenced,
            and have access to the <code>@server</code> object within the function.
          </p>
          <p>
            For example, we can use this to 
            dynamically reference other attributes, like so:
          </p>
          <pre><code>global:
  aws_security_groups: -> [ @server.env +’-’+ @server.type ]</code></pre>
          <p>
            We love that we can take this type of data-as-code approach, 
            and its one of the most compelling
            reasons why we prefer a javascript-based devops solution.
          </p>
          <h3 id="calculated-attributes">4.6. Calculated Attributes</h3>
          <p>
            Finally, some attributes are calculated and appended for you by 
            Borg at runtime, even though you didn’t specify them anywhere. 
            These can be based on parts of the server name 
            (e.g., <code>@server.type</code>, <code>@server.id</code>, <code>@server.subproject</code>, <code>@server.env</code>, <code>@server.tld</code>, <code>@server.fqdn</code>) or position in the hierarchy (e.g., <code>@server.datacenter</code>, <code>@server.group</code>).
          </p>
          <h2 id="scripts">5. Scripts</h2>
          <h3 id="importing">5.1. Importing</h3>
          <pre><code>@import @cwd, ‘’</code></pre>
          <h3 id="debugging">5.2. Debugging</h3>
          <pre><code>@log()</code></pre>
          <pre><code>borg debug</code></pre>
          <h3 id="asynchronous-flow-control">5.3. Asynchronous Flow Control</h3>
          <pre><code>@then
@call
@inject_flow (end) =>
@die()</code></pre>
          <h3 id="cryptography">5.4. Cryptography</h3>
          <pre><code>@encrypt() / @decrypt()</code></pre>
          <h3 id="iteration">5.5. Iteration</h3>
          <pre><code>@each()
@eachServer()</code></pre>
          <h2 id="resources">6. Resources</h2>
          <h3 id="common">6.1. Common</h3>
          <p>There is a third-party submodule that comes with every new <code>borg init</code> and that is the borg-scripts/resources repository. It holds the 
            most basic functions you would expect to use in any project.
          </p>
          <p>
            Notice that these are kept very light-weight. The list is 
            short but they do a lot by themselves. The preference though is 
            very biased toward bash scripting muscle. In the author’s 
            opinion, it makes more sense for three reasons:
          </p>
          <ol>
            <li>
              Someone not familiar with borg but who is familiar with bash 
              could more readily read / QA a borg script and copy/paste from 
              it to achieve the same outcome.
            </li>
            <li>
              Typically the process for making a new script involves first 
              making the server manually, which results in a bash history 
              which is used as a template for the devops script. It saves 
              time to be able to simply paste the bash history into Borg, 
              rather than have to translate it to yet another domain 
              specific language (DSL), and back out to bash when 
              debugging/troubleshooting.
            </li>
            <li>
              Well written bash script tends to be terse and powerful, 
              resulting in far less boilerplate and complexity than the 
              equivalent heavy resource.
            </li>
            <p>
              Also notice that at the moment they’re all targeting Ubuntu
              server exclusively. Although its half-expected that resources 
              will all be converted to an OS-agnostic version in the future, 
              the author hasn’t had any immediate need for it, yet. Expect 
              it to be added sooner if someone will volunteer the pull request.
            </p>
          </ol>
          <pre><code>@execute()
@package_update()
@install()
@uninstall()
@directory()
@chown()
@chmod()
@template()
@upload()
@download()
@link()
@remote_file_exists()
@append_line_to_file()
@replace_line_in_file()
@user()
@group()
@deploy()
@reboot()</code></pre>
          <h3 id="third-party-submodules">6.2. Third-Party Submodules</h3>
          <pre><code>borg install
borg update</code></pre>
          <p>The documentation for resources can be found in their individual repos.</p>
          <p>For a listing of available repos, see:<br><a href="https://github.com/borg-scripts">https://github.com/borg-scripts</a></p>
          <h2 id="contributing">7. Contributing</h2>
          <p>Your contributions are welcome via Github.com.</p>
          <h3 id="issuing-a-pull-request">7.1. Issuing a Pull Request</h3>
          <ol>
            <li>
              <p>fork and clone <a href="https://github.com/mikesmullin/borg">https://github.com/mikesmullin/borg</a></p>
            </li>
            <li>edit to heart&rsquo;s content</li>
            <li>
              <p>publish to your fork:</p>
              <pre><code>git commit && git push</code></pre>
            </li>
            <li>issue pull request to official fork, and we will review and approve or provide feedback.</li>
          </ol>
        </div>
      </article>
      <aside>
        <div class="wrapper">
          <div class="content">
            <h3>Chapters</h3>
            <ol>
              <li><a href="index.html#getting-started">Getting Started</a>
                <ul>
                  <li><a href="index.html#install-node.js">Install Node.JS</a></li>
                  <li><a href="index.html#install-borg">Install Borg</a></li>
                  <li><a href="index.html#generate-a-new-project">Generate a New Project</a></li>
                  <li><a href="index.html#explore-help">Explore Help</a></li>
                </ul>
              </li>
              <li><a href="index.html#cloud-integration">Cloud Integration</a>
                <ul>
                  <li><a href="index.html#amazon-web-services">Amazon Web Services</a></li>
                </ul>
              </li>
              <li><a href="index.html#introduction">Introduction</a>
                <ul>
                  <li><a href="index.html#vernacular">Vernacular</a></li>
                  <li><a href="index.html#directory-structure">Directory structure</a></li>
                </ul>
              </li>
              <li><a href="index.html#attributes">Attributes</a>
                <ul>
                  <li><a href="index.html#attribute-precedence">Attribute Precedence</a></li>
                  <li><a href="index.html#cascading-attributes">Cascading Attributes</a></li>
                  <li><a href="index.html#@networks-object">@networks object</a></li>
                  <li><a href="index.html#@server-object">@server object</a></li>
                  <li><a href="index.html#attribute-functions">Attribute Functions</a></li>
                  <li><a href="index.html#calculated-attributes">Calculated Attributes</a></li>
                </ul>
              </li>
              <li><a href="index.html#scripts">Scripts</a>
                <ul>
                  <li><a href="index.html#importing">Importing</a></li>
                  <li><a href="index.html#debugging">Debugging</a></li>
                  <li><a href="index.html#asynchronous-flow-control">Asynchronous Flow Control</a></li>
                  <li><a href="index.html#cryptography">Cryptography</a></li>
                  <li><a href="index.html#iteration">Iteration</a></li>
                </ul>
              </li>
              <li><a href="index.html#resources">Resources</a>
                <ul>
                  <li><a href="index.html#common">Common</a></li>
                  <li><a href="index.html#third-party-submodules">Third-Party Submodules</a></li>
                </ul>
              </li>
              <li><a href="index.html#contributing">Contributing</a>
                <ul>
                  <li><a href="index.html#issuing-a-pull-request">Issuing a Pull Request</a></li>
                </ul>
              </li>
            </ol>
          </div>
        </div>
      </aside>
      <footer>
        <div class="wrapper">
          <p>This documentation is licensed <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0</a></p>
          <p>"Borg" is a service mark of <a href="http://smullindesign.com">Smullin Design</a>.</p>
        </div>
      </footer>
    </div>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Rambla:400,700|Source+Sans+Pro:400,600">
  </body>
</html>