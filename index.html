<!DOCTYPE html>
<html>
  <head>
    <title>Borg Documentation</title>
    <link rel="stylesheet" href="stylesheets/global.css">
  </head>
  <body>
    <div id="content">
      <nav id="top">
        <div class="wrapper">
          <h1 class="logo">Borg Documentation</h1>
          <ul class="right">
            <li><a href="https://github.com/mikesmullin/borg">Github</a></li>
            <li class="toc"><a href="index.html#top">Docs</a></li>
            <li><a href="index.html#contributing">Contribute</a></li>
            <li><a href="https://github.com/mikesmullin/borg/graphs/contributors">Credits</a></li>
          </ul>
          <div class="clear"></div>
        </div>
      </nav>
      <header>
        <div class="wrapper">
          <h2>Borg Documentation (v0.0.1)</h2>
          <p>This information is designed to make you immediately productive with <strong><a href="https://www.npmjs.com/package/borg">Borg v0.0.4</a></strong>.<br>When additional versions are released, previous versions will be linked here.<br>Let&rsquo;s get started!</p>
        </div>
      </header>
      <article>
        <div class="wrapper">
          <h2 id="getting-started">1. Getting Started</h2>
          <h3 id="install-node.js">1.1. Install Node.JS</h3>
          <p>Using <a href="https://github.com/creationix/nvm">NVM </a> to install <a href="http://nodejs.org">Node.JS</a> is recommended.</p>
          <pre><code class="nohighlight">curl https://raw.github.com/creationix/nvm/master/install.sh | sh
nvm install v0.10.28 # latest stable preferred
nvm use v0.10.28
nvm alias default v0.10.28</code></pre>
          <h3 id="install-borg">1.2. Install Borg</h3>
          <pre><code class="nohighlight">npm install borg -g</code></pre>
          <h3 id="generate-a-new-project">1.3. Generate a New Project</h3>
          <pre><code class="nohighlight">borg init Devops
cd Devops/</code></pre>
          <p>Or, hit the ground running by cloning our <a href="https://github.com/mikesmullin/borg-sample-project">existing sample project</a> which can produce a web server hosting a mirror of this documentation.</p>
          <h3 id="explore-help">1.4. Explore Help</h3>
          <p>The <code>borg</code> <strong>Command Line Interface (<a href="http://en.wikipedia.org/wiki/Command-line_interface">CLI</a>)</strong> contains many commands which are not documented here. That documentation
            is expected to be accessed directly, beginning with the following command:
          </p>
          <pre><code class="nohighlight">borg help</code></pre>
          <p><strong style="color:#999">NOTICE:</strong> Most <code>borg</code> CLI commands require your working directory to be the project root.</p>
          <h2 id="cloud-integration">2. Cloud Integration</h2>
          <p>
            Though abstracted to integrate with any cloud provider,
            only <a href="http://aws.amazon.com/">Amazon Web Services</a> integration is implemented at present.
          </p>
          <h3 id="amazon-web-services">2.1. Amazon Web Services</h3>
          <p>This integration depends on the AWS CLI utility being installed:</p>
          <pre><code class="nohighlight">cd /tmp
wget https://s3.amazonaws.com/aws-cli/awscli-bundle.zip
unzip awscli-bundle.zip
sudo ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws
aws --version # test</code></pre>
          <p>and configured:</p>
          <pre><code class="nohighlight">aws configure
Access Key ID: your-aws-access-key-id
Secret Access Key: your-aws-secret-key</code></pre>
          <p>For more information, please see:<br><a href="http://docs.aws.amazon.com/AWSEC2/latest/CommandLineReference/set-up-ec2-cli-linux.html">Setting Up the Amazon EC2 Command Line Interface Tools</a></p>
          <h2 id="introduction">3. Introduction</h2>
          <h3 id="vernacular">3.1. Vernacular</h3>
          <ul>
            <li><strong>script: </strong>file containing code listing steps to complete orchestration.<br><br></li>
            <li> <strong>resource: </strong>named function organizing common steps for reuse across multiple scripts; often with the secondary goal of becoming operating system agnostic.<br><br></li>
            <li> <strong>server: </strong>file containing code defining how remote machines are named and addressed, and which scripts must be applied in order to complete their orchestration.<br><br></li>
            <li> <strong>attribute: </strong>server variable; representing static data, dynamic runtime calculation functions, or personal preferences/overrides for use by scripts at runtime.<br><br></li>
            <li> <strong>networks.coffee: </strong>file containing a list of servers and their attributes--as well as the relationship of one server to another in a hierarchy of datacenters, groups, server types, and server instances.<br><br></li>
            <li> <strong>datacenter: </strong>the outermost unit available for the grouping of reusable server definitions (e.g., one datacenter may contain two or more instances of the same server)<br><br></li>
            <li> <strong>group: </strong>another layer of organization available for the grouping of servers within datacenters; typically named after the environment and project (e.g., a datacenter may contain a group for the production environment of Project A as well as the staging environment for Project B, both of which contain separate instances of the same type of server)<br><br></li>
            <li> <strong>borg create: </strong>to provision a new empty remote server via cloud provider apis.<br><br></li>
            <li> <strong>borg assimilate: </strong>to orchestrate a remote server.<br><br></li>
            <li> <strong>borg assemble: </strong>to both <code>create</code> and then <code>assimilate</code>.<br><br></li>
          </ul>
          <h3 id="directory-structure">3.2. Directory structure</h3>
          <pre><code class="nohighlight">attributes/		JSON and CSON files; see <a href="index.html#attributes">Attributes</a> chapter below
  networks.coffee	your datacenter and server hierarchy
  memory.json		remembers details from cloud provider api interactions
scripts/		your Scripts; see <a href="index.html#scripts">Scripts</a> chapter below
  server/		code defining which Servers use which Scripts
  vendor/		third-party Scripts as Git submodules</code></pre>
          <h2 id="attributes">4. Attributes</h2>
          <p>Attribute files are regular <a href="http://coffeescript.org">CoffeeScript</a> files, appropriately suffixed <code>.coffee</code>, but some of them might more effectively thought of as <strong>CoffeeScript Object Notation (<a href="https://github.com/bevry/cson">CSON</a>)</strong>; a variation of <a href="http://www.json.org/">JSON</a> that allows you to, among other things, make use of <a href="http://coffeescript.org/#strings">comments</a>, <a href="http://coffeescript.org/#strings">string interpolation</a>, <a href="http://coffeescript.org/#literals">function values</a>, and conditional logic such as <a href="http://coffeescript.org/#conditionals">ternary</a> and <a href="http://coffeescript.org/#switch">switch statements</a>. These features make it a more versatile alternative to <a href="http://www.yaml.org/">YAML</a>.</p>
          <p>
            It is recommended to take advantage of these features to achieve,
            as close as possible, the overall goal of <strong><a href="http://en.wikipedia.org/wiki/Don%27t_repeat_yourself">DRY</a> (Don’t Repeat Yourself)</strong> and readability. Strive to simplify the job of an
            application maintainer who will only want to look in a single place
            to change any attribute value generated by the devops scripts.
          </p>
          <p>
            There are times when it is appropriate for an attribute to be 
            defined in more than one place. Borg knows which value to use 
            in these cases because it merges attribute files in a <a href="index.html#attribute-precedence">specific order</a> at runtime. For example, your attribute definitions will 
            override any defaults provided by third-party submodules. 
          </p>
          <p>
            The resulting attribute values are accessible to all scripts 
            from within the <code><a href="index.html#@server-object">@server</a></code> object, which is also pretty printed 
            to the debug log at the beginning of each run.
          </p>
          <h3 id="attribute-precedence">4.1. Attribute Precedence</h3>
          <p>
            Although it may seem straightforward, when making changes its 
            important to be sure any changes to attribute values won’t be 
            accidentally overridden. To help illustrate both the various 
            locations where attributes can be defined, and the order that 
            they get merged to produce the final result, we’ve assembled 
            the handy chart below, in order of precedence:
          </p>
          <table>
            <thead>
              <tr>
                <th>Name, Location, Precedence</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <p><strong id="hard-coded-attributes">1. Hard-coded Attributes</strong><br>scripts/*/*.coffee<br>scripts/*/templates/*/*.coffee<br><em>(un-overridable precedence)</em></p>
                  <p>
                    Always scrutinize whether there are values in
                    your scripts which would be more useful as attributes
                    that others can see and modify.
                  </p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define local variables which remain
                    private to only one script and its templates.
                  </p>
                  <p>
                    Calculations, for example, may be based on a combination
                    of attributes defined elsewhere--such as in a
                    concatenation operation, or a hashing operation, or any
                    kind of last-minute reformatting.
                  </p>
                  <p><strong>Convention:</strong><br>Defining constants or overriding attributes within the
                    template code itself is discouraged, because its
                    difficult for other users to change these and remain
                    compatible with your upstream. The only exception is
                    when a script author is certain the resulting output is
                    unlikely to be a desired change.
                  </p>
                  <p>
                    As it happens, most scripts end up 100% hard-coded as
                    a convenience for authors in a hurry to get testing and building
                    servers. However, these aren't useful for sharing publicly
                    until all values are abstracted as overridable attributes.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="cli-attributes">2. CLI <code>--locals=</code> Attributes</strong><br>Process arg w/ CSON value<br><em>(high precedence)</em></p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define short-term instance attribute values unique to this run.</p>
                  <p><strong>Convention:</strong><br>Commonly these are one-time values that are expected to change
                    by the end of a successful run.
                  </p>
                  <p>
                    For example, if a script was expected to change the sshd listen
                    port, but aborted due to an  error before that step was reached,
                    you may want to override that setting temporarily until you are
                    done debugging and retrying.<br>(e.g., <code>ssh: port:</code>, <code>user:</code>, <code>pass:</code>, <code>key:</code>)
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="global-attributes">3. Global Attributes</strong><br>attributes/networks.coffee<br>in the <code>global:</code> key</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define long-term instance attribute default values in the most general way possible.</p>
                  <p><strong>Convention:</strong><br>Rarely useful for global user preferences.<br>(e.g., <code>ssh: port</code> or <code>tz:</code>)</p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="datacenter-attributes">4. Datacenter Attributes</strong><br>attributes/networks.coffee<br>in the <code>datacenters:</code> key</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Define long-term attribute values per-datacenter,
                    per-environment, per-group, per-type, and/or per-instance.
                  </p>
                  <p><strong>Convention:</strong><br>Perhaps the most commonly used area to specify attributes
                    of any.
                  </p>
                  <p>
                    Details information specific to an instance, such as 
                    the AWS AMI, instance size, region id, zone, security group,
                    as well as information used by scripts, such as
                    memory settings, the number of instances to create in
                    each datacenter, and how they are grouped. (e.g., by environment)
                  </p>
                  <p>
                    Also provides individual scripts with hierarchical graph of
                    all defined systems in the local and extended network,
                    represented by the <code>@networks</code> variable, which is intended to be useful when dynamically
                    configuring firewall, monitoring, whitelists or other lists
                    that need to access relational information about servers other
                    than the one currently assimliating.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="server-attributes">5. Server Attributes</strong><br>scripts/servers/*.coffee<br>within the exported function <code>assimilate: -></code></p>
                  <p>
                    Usually there is at least one of these files for each type
                    of server.
                  </p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Default attributes unique to servers of one type.</p>
                  <p>
                    These files also define the order that scripts are 
                    executed to complete assimilation of the machine.
                  </p>
                  <p><strong>Convention:</strong><br>For example, a set of attribute values shared by servers 
                    "web01", "web02", ... "web09"
                    could all be defined once in a file called <code>scripts/servers/web.coffee</code>
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="script-attributes">6. Script Attributes</strong><br>scripts/*/attributes/*/*.coffee</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>The most appropriate place for a script author to declare
                    all script attributes and set default values which can
                    be later overridden, because it is packaged together with
                    the script when shared.
                  </p>
                  <p>
                    Also the best place to look first for a list of attributes
                    you can override if you are a new user of a third-party
                    script.
                  </p>
                  <p><strong>Convention:</strong><br>It is recommended to define defaults for all script
                    attributes so the user only has to define overriding values
                    to address unusual cases.
                  </p>
                </td>
              </tr>
              <tr>
                <td>
                  <p><strong id="memory-attributes">7. Memory Attributes</strong><br>attributes/memory.json<br><em>(lowest precedence)</em></p>
                  <p>Users should avoid modifying this file directly.</p>
                </td>
                <td>
                  <p><strong>Purpose:</strong><br>Data remembered by Borg after successfully interacting with 
                    the cloud provider API.
                  </p>
                  <p><strong>Convention:</strong><br>Great for things you don’t want to have to constantly insert
                    into an attribute file manually; things Borg can figure out
                    on its own, or that can only be figured out during/after a
                    run.
                  </p>
                  <p>
                    These are commonly used when automatically 
                    connecting to a newly made server, or deleting an existing 
                    server.<br>(e.g., <code>@server.instance_id</code>, <code>@server.public_ip</code>)
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
          <h3 id="cascading-attributes">4.2. Cascading Attributes</h3>
          <p>This next section applies specifically only to the <code>./attributes/networks.coffee</code> file. The goal with this file is to create an object hierarchy like: <code>datacenters: D1: groups: G1: servers: S1: instances: I1: PROPERTY: VALUE</code> where ALL-CAPS keys are names you would invent.
            This hierarchy of <strong>cascading attributes</strong> (like <a href="https://developer.mozilla.org/en-US/docs/Web/CSS">cascading style sheets</a>)
            allow the most generic definitions at the root (least <a href="http://www.smashingmagazine.com/2007/07/27/css-specificity-things-you-should-know/">specificity</a>)
            to be inherited all the way down to the most specific definitions in
            the deepest leaves (most specificity; in this case, <code>I1</code>) to define the network.
          </p>
          <p>
            Observe how the keys are then inherited by instances 
            through a <a href="https://lodash.com/docs#merge"><code>_.merge()</code></a> to create the final fully-detailed 
            instance-level leaves a.k.a. the final object representing all 
            the keys attributed to a specific server instance. In order of 
            objects merged; latter overrides former.
          </p>
          <ol>
            <li><code>global.*</code></li>
            <li><code>datacenters.*.*</code> (except key: <code>groups</code>)</li>
            <li><code>datacenters.*.groups.*.*</code> (except key: <code>servers</code>)</li>
            <li><code>datacenters.*.groups.*.servers.*.*</code> (except key: <code>instances</code>)</li>
            <li><code>datacenters.*.groups.*.servers.*.instances.*.*</code></li>
          </ol>
          <h3 id="@networks-object">4.3. @networks object</h3>
          <p>A <code>networks.coffee</code> structure like:</p>
          <pre><code class="cson">global:
  ssh_port: 3562
datacenters:
  aws-ca:
    provider: 'aws'
    groups:
      'prod-myproject':
         env: 'prod'
         tld: '.myproject.tld'
         servers:
           'myapp':
             aws_size: 't2.micro'
             instances:
               '01':
                 aws_size: 'm3.xlarge'
                 secondary_ip: '1.2.3.4'
               '02':
                 secondary_ip: '1.2.3.5'</code></pre>
          <p>Will be merged into a <code>@networks</code> object, in scope from within scripts:</p>
          <pre><code class="cson">@networks.datacenters['aws-ca'].groups['prod-myproject'].servers['my-app'].instances['01'] =
  aws_size: 'm3.xlarge'
  secondary_ip: '1.2.3.4'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562
@networks.datacenters['aws-ca'].groups['prod-myproject'].servers['my-app'].instances['02'] =
  aws_size: 't2.micro'
  secondary_ip: '1.2.3.5'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562</code></pre>
          <p>
            So our script can now reach attributes for all servers, and it can
            lookup attributes by their relationship to other servers in the
            network hierarchy. (e.g., what is the secondary_ip of each my-app
            server in the same datacenter and group as the current server?)
          </p>
          <h3 id="@server-object">4.4. @server object</h3>
          <p>
            But there is also a shortcut to the current server’s attributes--
            which in the above case, if we pretend the current server is my-app02, 
            would be:
          </p>
          <pre><code class="cson">@server =
  aws_size: 't2.micro'
  secondary_ip: '1.2.3.5'
  env: 'prod'
  tld: '.myproject.tld'
  provider: 'aws'
  ssh_port: 3562</code></pre>
          <h3 id="attribute-functions">4.5. Attribute Functions</h3>
          <p>
            Notice you can define function values which are [re-]evaluated
            (as a <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/get">javascript getter</a>)
            at runtime every time they are referenced,
            and have access to the <code>@server</code> object within the function.
          </p>
          <p>
            For example, we can use this to 
            dynamically reference other attributes, like so:
          </p>
          <pre><code class="coffee">global:
  aws_security_groups: -> [ @server.env +’-’+ @server.type ]</code></pre>
          <p>
            We love that we can take this type of data-as-code approach, 
            and its one of the most compelling
            reasons why we prefer a javascript-based devops solution.
          </p>
          <h3 id="calculated-attributes">4.6. Calculated Attributes</h3>
          <p>
            Finally, some attributes are calculated and appended for you by 
            Borg at runtime, even though you didn’t specify them anywhere. 
            These can be based on parts of the server name 
            (e.g., <code>@server.type</code>, <code>@server.id</code>, <code>@server.subproject</code>, <code>@server.env</code>, <code>@server.tld</code>, <code>@server.fqdn</code>) or position in the hierarchy (e.g., <code>@server.datacenter</code>, <code>@server.group</code>).
          </p>
          <h2 id="resources">5. Resources</h2>
          <p>All resources are just <em><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function">functions</a></em>.
            Within every script and callback--anyplace that would typically
            be considered a space the average devops scripter would occupy,
            there is a carefully crafted object provided as the reference
            of <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/this">this</a></code> in Javascript or <code><a href="http://coffeescript.org/#operators">@</a></code> in CoffeeScript. It is where the <code><a href="index.html#@server-object">@server</a></code> object lives, and it is also where all resources can be found.
          </p>
          <p>Borg's resources are divided into three categories:</p>
          <ul>
            <li><strong><a href="index.html#scripts">Core Resources</a>:</strong> Resources referenced by Borg core itself;
              these are shipped with and are inseparable from Borg.
              They can generally be considered part of the <strong>Domain Specific Language (<a href="http://en.wikipedia.org/wiki/Domain-specific_language">DSL</a>)</strong> which all scripts use. There are deliberately as few as
              possible defined.<br><br>
            </li>
            <li><strong><a href="index.html#common-resources">Common Resources</a>:</strong> Resources most people expect to be there, but aren't needed by Borg core;
              these are packaged externally like a third-party resource, and installed as a Git submodule by <code>borg init</code> with all new projects. That is so anyone who might decide one of its
              resources isn't good enough for them can replace, modify, or override it.<br><br>
            </li>
            <li><strong><a href="index.html#third-party-resources">Third-Party Resources</a>:</strong> Resources which clearly wouldn't be used by every project;
              these are packaged externally and installed as <a href="http://git-scm.com/book/en/v2/Git-Tools-Submodules">
                <Git>submodules</Git></a> by <code>borg install</code> as-needed. That is so anyone can author a set of resources and share 
              with others as easily as uploading to <a href="http://github.com">Github.com</a>.
            </li>
          </ul>
          <p>Each of these are discussed further in their own separate chapters below.</p>
          <h2 id="scripts">6. Scripts</h2>
          <p>Writing scripts that define <em>how you want your servers built</em> is the whole purpose of Borg, and every other feature is only a facilitator
            toward that goal. The focus surrounds complete control and convenience--
            for a <em><a href="http://i.imgur.com/dBNfqlQ.jpg">programmer</a></em>; someone who dreams in code and works in shells every day.
          </p>
          <h3 id="defining-servers">6.1. Defining Servers</h3>
          <p>A server definition links your scripts and your <a href="index.html#datacenter-attributes">datacenter attributes</a> to
            a single <strong>Fully Qualified Domain Name (<a href="https://kb.iu.edu/d/aiuv">FQDN</a>)</strong> which you can use on the CLI,
            according to the custom naming convention below.
          </p>
          <p><strong>FQDN Format:</strong></p>
          <pre><code class="nohighlight">[<a href="index.html#fqdn-datacenter">datacenter</a>]-[<a href="index.html#fqdn-env">env</a>]-[<a href="index.html#fqdn-type">type</a>][<a href="index.html#fqdn-instance">instance</a>]-[<a href="index.html#fqdn-subproject">subproject</a>].[<a href="index.html#fqdn-tld">tld</a>]</code></pre>
          <p><strong>Definitions:</strong></p>
          <ul>
            <li><strong id="fqdn-datacenter">datacenter:</strong> Must uniquely match a key you define inside the <code>datacenters:</code> key.<br>(e.g., <code>aws-ca</code> might signify the Amazon Web Services datacenter in California)<br><br></li>
            <li><strong id="fqdn-env">env:</strong> Must match an<code>env:</code> key value you define.<br>Unique match determined by <code>datacenter</code>+<code>env</code>. <br>(e.g., <code>dev</code>, <code>stage</code>, <code>prod</code> are recommended)<br><br></li>
            <li><strong id="fqdn-type">type:</strong> Must match a key you define inside a <code>servers:</code> key.<br>Unique match determined by <code>datacenter</code>+<code>env</code>+<code>type</code>. <br>(e.g., <code>web</code> might represent horizontally scaling servers hosting your website)<br><br></li>
            <li><strong id="fqdn-instance">instance:</strong> Must match a key you define inside an <code>instances:</code> key.<br>Unique match determined by <code>datacenter</code>+<code>env</code>+<code>type</code>+<code>instance</code>. <br>(e.g., <code>01</code> might represent the first instance of many more servers like it)<br><br></li>
            <li><strong id="fqdn-subproject">subproject</strong> (Optional):
               Must match a <code>subproject:</code> key value you define anywhere below the <code>datacenters:</code> key. <br>Unique match determined by <code>datacenter</code>+<code>subproject</code>. <br>(e.g., <code>mobile</code> might represent the mobile counterpart to your desktop product,
              if the architecture were significantly different)<br><br>
            </li>
            <li><strong id="fqdn-tld">tld:</strong> (Optional):
               Must match a <code>tld:</code> key value you define anywhere below the <code>datacenters:</code> or <code>globals:</code> keys. 
              Does not have to be unique.<br>(e.g., <code>.example.org</code> might be your corporate domain)
            </li>
          </ul>
          <p>All definitions of valid values for your project happen inside the <code><a href="index.html#@networks-object">networks.coffee</a></code> file.</p>
          <p>
            The motivation is to simplify
            command-line interactions so:
          </p>
          <ol>
            <li>Commands remain simple.</li>
            <li>Complicated logic connecting everything together remains in code where it belongs.</li>
            <li>
              <p style="margin-top: 0">
                Borg can guess your intentions when naming previously undefined new servers,
                and do the right thing. For example, if all you have defined is:
              </p>
              <pre><code class="cson">datacenters:
  'aws-ca':
    tld: '.example.org'
    groups:
      'mikes-dev':
         env: 'dev'</code></pre>
              <p> and a <code>scripts/servers/web.coffee</code> server definition, Borg will only pause briefly to prompt for 
                human confirmation that you mean
                to permanently define new servers (via <code><a href="index.html#memory-attributes">memory.json</a></code>) when you specify commands like:
              </p>
              <pre><code class="nohighlight">borg create aws-ca-dev-web01.example.org
borg assimilate aws-ca-dev-web02.example.org
borg assemble aws-ca-dev-web99.example.org</code></pre>
              <p>
                ...and carry on to do exactly what you had intended. Any further
                commands referencing those FQDN will be treated exactly as any
                other pre-defined server, since they are remembered by Borg until <code>borg destroy</code> is called, or they are otherwise deleted from <code>memory.json</code>.
              </p>
            </li>
          </ol>
          <p>The basic server definition looks like this:</p>
          <pre><code class="coffee"># scripts/servers/web.coffee
module.exports =
  target: ->
    @server.type is 'web'
  assimilate: ->
    @import @cwd, 'scripts', 'web'</code></pre>
          <p>The callback function <code>target: -></code> is expected to return a <a href="http://en.wikipedia.org/wiki/Boolean_data_type">boolean</a> determining whether the current <code>@server</code> object matches this server definition. Since this is CoffeeScript,
            all statements are expressions, and the last expression of any function
            is always returned, unless otherwise specified. So that's exactly
            what this example does.
          </p>
          <p><strong style="color:#999">NOTICE:</strong> Borg will only process the first match found in <code>scripts/servers/*.coffee</code> .</p>
          <p>When a match is found, the next callback function <code>assimilate: -></code> is executed. From there it is up to you to specify
            any commands or <code>@import</code> declarations that act upon the remote server to
            complete orchestration.
          </p>
          <h3 id="importing-code">6.2. Importing Code</h3>
          <p>The import declaration takes arguments similarly to <code><a href="http://nodejs.org/api/path.html#path_path_join_path1_path2">path.join()</a></code>. The <code>@cwd</code> variable is a string provided by Borg holding the result of <code><a href="http://nodejs.org/api/process.html#process_process_cwd">process.cwd()</a></code> which is expected to be the absolute path to the root of your
            Borg project.
          </p>
          <pre><code class="coffee">  @import @cwd, 'scripts', 'vendor', 'redis', 'server'</code></pre>
          <p>This will <code><a href="http://nodejs.org/api/modules.html">require()</a></code> a script located at <code>scripts/vendor/redis/server.coffee</code>, which in this case can be expected to be provided by a third-party 
            resource named <code><a href="https://github.com/borg-scripts/redis/blob/master/server.coffee">redis</a></code>. For example, if someone had run the CLI command:
            <pre><code class="nohighlight">borg install redis</code></pre>
          </p>
          <p>...at some point in the project's history.</p>
          <p><strong style="color:#999">NOTICE:</strong> Its important to use <code>@cwd</code> because it can point to other projects if Borg is 
            being loaded as a library inside of another application.
          </p>
          <p><strong style="color:#999">NOTICE: </strong><code>@import</code> is what actually overrides the scope of <code>this</code> or <code>@</code> for the module.</p>
          <h3 id="asynchronous-flow-control">6.3. Asynchronous Flow Control</h3>
          <p>There are a lot of ways to do this, but we like <strong>Continuation-Passing Style (<a href="http://matt.might.net/articles/by-example-continuation-passing-style/">CPS</a>)</strong>. One well-known caveat to using this approach is remembering that all <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Statements">Javascript flow-control statements</a>--such as<code>if</code>, <code>else</code>, <code>try</code>, <code>catch</code>, etc.--don't normally apply.</p>
          <p>The popular solution is to select <a href="https://github.com/caolan/async">a</a> <a href="https://www.npmjs.com/package/promise">third</a>-<a href="https://www.npmjs.com/package/q">party</a> <a href="https://github.com/mikesmullin/async2">library</a> providing
            the equivalent behavior as a set of user-defined functions. Borg provides
            its own set of functions for this purpose.
          </p>
          <p>From the <strong>script developer</strong> perspective, all you need to know is <code>@then()</code>; you can think of it as an alias for <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/push">Array::push()</a></code> on an array holding a list of your functions
            which will be executed in-order, all-at-once, later
            after all scripts have been processed.
          </p>
          <p>For example:</p>
          <pre><code class="coffee">@then (cb) =>
  console.log "This won't be executed until later."
  cb()</code></pre>
          <p>
            Except--instead of passing an anonymous function you've just defined--most
            of the time you are passing strings into predefined resource functions
            which do the heavy lifting, and hide the passing of callbacks behind an 
            alluringly simple syntax. Your scripts look more like this:
          </p>
          <pre><code class="coffee">@then @log "This won't be executed until later."</code></pre>
          <p>Which means, from the <strong>resource developer</strong> perspective, your resource functions are defined with a compatible signature, like this:</p>
          <pre><code class="coffee">module.exports = -> <a href="https://lodash.com/docs#assign">_.assign</a> @,
 some_resource: (names, [o]...) => (cb) =>
   # your code here
   cb()</code></pre>
          <p>
            Actually, most times you want to continue using async flows inside your
            resource. For that we have <code>@inject_flow()</code> which looks like this:
          </p>
          <pre><code class="coffee">module.exports = -> _.assign @,
 sync_clock: (names, [o]...) => @inject_flow =>
   @then <a href="index.html#@execute()">@execute</a> "sudo ntpdate -s time.nist.gov"
   # no callback hell pyramids here</code></pre>
          <p>
            There are three major reasons why we require asynchronous control flow
            to get anything done in Borg, versus a DSL that is strictly blocking,
            or simply pasting one long bash script in a string block for that matter.
          </p>
          <ol>
            <li>
              Its critical to the extensibility and dynamism of the attribute system
              that we have a two-pass system of script evaluation. The first pass
              being the one defining attributes and enqueuing functions to the <a href="http://strongloop.com/strongblog/node-js-event-loop/">giant</a> <a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">event loop</a> <a href="http://blog.carbonfive.com/2013/10/27/the-javascript-event-loop-explained/">in</a> <a href="http://stackoverflow.com/questions/19822668/what-exactly-is-a-node-js-event-loop-tick">the</a> <a href="http://chimera.labs.oreilly.com/books/1234000001808/ch03.html#chap3_id35941348">sky</a>. The second pass being the one actually performing actions on the
              remote server during orchestration--possibly re-evaluating
              attributes since the first pass, in reaction to a server response,
              or another script.<br><br>
            </li>
            <li>
              Eventually, your script could be super-parallelized; like multiple
              SSH connections to one remote server, performing complimentary
              steps at the same time. Admittedly this application
              has yet to be demonstrated.<br><br>
            </li>
            <li>
              Some resources might actually be using functions that are asynchronous
              even though your script code may not.
            </li>
          </ol>
          <p>
            There are more resources related to async that might become
            useful as you get further along. You can find them by reviewing
            examples in the common <code><a href="https://github.com/borg-scripts/resources/blob/master/index.coffee">resources</a></code> resource, and in <code><a href="https://github.com/mikesmullin/borg/blob/master/Borg.coffee">Borg.coffee</a></code>.
          </p>
          <h3 id="cryptography">6.4. Cryptography</h3>
          <p>
            You are encouraged to use the following resources
             to obfuscate strings in your project repository.
            Its a smart thing to do with sensitive information,
            which would then be relatively safe even if your
            devops scripts were accidentally leaked.
          </p>
          <pre><code class="coffee">@then @die @encrypt "example utf8 string"
decrypted_string = @decrypt "example base64 string"</code></pre>
          <p>The cipher is OpenSSL <a href="http://en.wikipedia.org/wiki/Advanced_Encryption_Standard">AES-256-CBC</a>. The key is derived
            from a file in your project root named <code>./secret</code> which typically contains a random 512-byte base64 string
            generated by <code>borg init</code> when your project is first initialized. This file
            should never be shared in the same way the project
            source is, or the encryption is useless.
          </p>
          <p>
            Likewise, you can also encrypt binary data files
            your scripts are expected to upload to remote servers,
            such as individualized software licenses, using the Borg CLI:
          </p>
          <pre><code class="nohighlight">borg encrypt # see help</code></pre>
          <p>and then passing the<code>decrypt: true</code> option when using resources like <code>@upload()</code> to transmit the local file to its remote location on the server.</p>
          <h3 id="console-debugging">6.5. Console Debugging</h3>
          <p>
            Some people prefer to temporarily sprinkle log
            statements throughout their code and then run it to see
            what order they appear on the console log:
          </p>
          <pre><code class="coffee">@then @log "Reaching here? Let's see what variable x is: #{x}."
console.log() # the non-async way</code></pre>
          <p>
            Sometimes also aborting just after the point of interest,
            to prevent going too far or taking a long time between
            iterations:
          </p>
          <pre><code class="coffee">@then @die "I am debugging. This is only temporary."
process.exit 1 # the non-async way</code></pre>
          <p>Its a valid strategy and occasionally faster than other methods.</p>
          <h3 id="interactive-debugging">6.6. Interactive Debugging</h3>
          <p>You can execute any <code>borg</code> CLI command with <code>debug</code> as the first parameter to launch a <a href="http://www.google.com/chrome/">Chrome</a> browser using <a href="https://developer.chrome.com/devtools">DevTools</a> . This will let you set and catch <code>debugger</code> breakpoints, pause, step over,
            step into, step out, continue, and inspect stack, backtrace, 
            variables, etc. From there the experience is very similar to any other 
            Javascript, Node.JS, or CoffeeScript application.
          </p>
          <pre><code class="nohighlight">borg debug assimilate aws-ca-dev-web01.example.org</code></pre>
          <h3 id="test-provisioning">6.7. Test Provisioning</h3>
          <p>There is a <code>test</code> mode you can enter with the Borg CLI, which keeps
            a separate list of servers provisioned in the cloud. This way, while
            testing, servers you create are still created at your cloud provider--as
            not to differ from the production environment hardware--but they
            have a "test-" prefix to set them apart.
          </p>
          <p>For example:</p>
          <pre><code class="nohighlight">borg test assimilate aws-ca-dev-web01.example.org</code></pre>
          <p>
            While in test mode, you can perform bulk operations such as
            provisioning every server from your dev environment to see
            if recent script modifications broke anything.
          </p>
          <pre><code class="nohighlight">borg test assimilate aws-ca-dev</code></pre>
          <p>The fourth argument is matching on regular expression.</p>
          <p>For more information, see:</p>
          <pre><code class="nohighlight">borg help test</code></pre>
          <h3 id="integration-testing">6.8. Integration Testing</h3>
          <p><strong style="color:#999">NOTICE:</strong> This feature is currently in development.</p>
          <p>A feature using <a href="http://mochajs.org/">Mocha</a> is planned to run tests in CoffeeScript that are able to
            execute commands for testing purposes.
            For example, it might be useful if, after a new machine is cooked,
            Borg were able to automatically connect to one or more of its peer servers
            as defined in <code>network.coffee</code> and perform a command <code>nc -vz s &lt;public_ip&gt; &lt;some_port&gt;</code> in order to determine if important ports were open to them.
          </p>
          <p>
            This type of test would essentially be attempting to reproduce, from the
            end-user's perspective, whether or not the assimilation resulted
            in a working service. You can imagine the output would look something
            like:
          </p>
          <pre><code class="nohighlight">user@host: ~/project$ borg checkup aws-ca-dev-web01.example.org
test: web:<br><span style="color:lime">&#x2714;</span> web01 was able to connect to redis01 on tcp/6379<br><span style="color:red">&#x2717;</span> web02 was NOT able to connect to redis01 on tcp/6379
   <span style="color:red">nc: getaddrinfo: Name or service not known</span> 
 
2 test(s) run in 204ms. 1 passed, 1 failed.</code></pre>
          <h3 id="jobs">6.9. Jobs</h3>
          <p><strong style="color:#999">NOTICE:</strong> This feature is currently in development.</p>
          <p>
            Jobs are essentially partial scripts, which are invoked from 
            the command-line and perform specific
            actions of a periodic nature on a remote server.
            For example, it could
            restart a service, or perform a software deployment, or
            truncate logs, or any other routine or mundane task.
          </p>
          <p>Jobs are located in <code>scripts/jobs/*.coffee</code>, which have the benefit of being distributed with
            and utilizing all the accompanying resources. For example, tasks
            related to the maintenance of a Percona server, such as peforming
            a backup snapshot, could be distributed along with the<code><a href="https://github.com/borg-scripts/percona">percona</a></code> resource which installs the service.
          </p>
          <h2 id="common-resources">7. Common Resources</h2>
          <p>There is a third-party submodule that comes with every new <code>borg init</code> and that is the borg-scripts/resources repository. It holds the 
            most basic functions you would expect to use in any project.
          </p>
          <p>
            Notice that these are kept very light-weight. The list is 
            short but they do a lot by themselves. The preference though is 
            very biased toward bash scripting muscle. In the author’s 
            opinion, it makes more sense for three reasons:
          </p>
          <ol>
            <li>
              Someone not familiar with borg but who is familiar with bash 
              could more readily read / QA a borg script and copy/paste from 
              it to achieve the same outcome.
            </li>
            <li>
              Typically the process for making a new script involves first 
              making the server manually, which results in a bash history 
              which is used as a template for the devops script. It saves 
              time to be able to simply paste the bash history into Borg, 
              rather than have to translate it to yet another domain 
              specific language (DSL), and back out to bash when 
              debugging/troubleshooting.
            </li>
            <li>
              Well-written bash script tends to be terse and powerful, 
              resulting in far less boilerplate and complexity than the 
              equivalent heavy resource.
            </li>
            <p>
              Also notice that at the moment they’re all targeting Ubuntu
              server exclusively. Although its half-expected that resources 
              will all be converted to an OS-agnostic version in the future, 
              the author hasn’t had any immediate need for it, yet. Expect 
              it to be added sooner if someone will volunteer the pull request.
            </p>
          </ol>
          <h3 id="@execute()">7.1. @execute()</h3>
          <h3 id="@package-update()">7.2. @package_update()</h3>
          <h3 id="@install()">7.3. @install()</h3>
          <h3 id="@uninstall()">7.4. @uninstall()</h3>
          <h3 id="@directory()">7.5. @directory()</h3>
          <h3 id="@chown()">7.6. @chown()</h3>
          <h3 id="@chmod()">7.7. @chmod()</h3>
          <h3 id="@template()">7.8. @template()</h3>
          <h3 id="@upload()">7.9. @upload()</h3>
          <h3 id="@download()">7.10. @download()</h3>
          <h3 id="@link()">7.11. @link()</h3>
          <h3 id="@remote-file-exists()">7.12. @remote_file_exists()</h3>
          <h3 id="@append-line-to-file()">7.13. @append_line_to_file()</h3>
          <h3 id="@replace-line-in-file()">7.14. @replace_line_in_file()</h3>
          <h3 id="@user()">7.15. @user()</h3>
          <h3 id="@group()">7.16. @group()</h3>
          <h3 id="@deploy()">7.17. @deploy()</h3>
          <h3 id="@reboot()">7.18. @reboot()</h3>
          <h2 id="third-party-resources">8. Third-Party Resources</h2>
          <pre><code>borg install
borg update</code></pre>
          <p>The documentation for resources can be found in their individual repos.</p>
          <p>For a listing of available repos, see:<br><a href="https://github.com/borg-scripts">https://github.com/borg-scripts</a></p>
          <h2 id="contributing">9. Contributing</h2>
          <p>Your contributions are welcome via Github.com.</p>
          <h3 id="issuing-a-pull-request">9.1. Issuing a Pull Request</h3>
          <ol>
            <li>
              <p>Fork and clone</p>
              <ul>
                <li>Main sources:<br><a href="https://github.com/mikesmullin/borg">https://github.com/mikesmullin/borg</a><br><br></li>
                <li>Documentation:<br><a href="https://github.com/mikesmullin/borg-docs">https://github.com/mikesmullin/borg-docs</a></li>
              </ul>
            </li>
            <li>Edit to heart&rsquo;s content</li>
            <li>
              <p>Publish to your fork:</p>
              <pre><code>git commit && git push</code></pre>
            </li>
            <li>Issue pull request to official repo, and we will review and approve or provide feedback.</li>
          </ol>
        </div>
      </article>
      <aside>
        <div class="wrapper">
          <div class="content">
            <h3>Chapters</h3>
            <ol>
              <li><a href="index.html#getting-started">Getting Started</a>
                <ul>
                  <li><a href="index.html#install-node.js">Install Node.JS</a></li>
                  <li><a href="index.html#install-borg">Install Borg</a></li>
                  <li><a href="index.html#generate-a-new-project">Generate a New Project</a></li>
                  <li><a href="index.html#explore-help">Explore Help</a></li>
                </ul>
              </li>
              <li><a href="index.html#cloud-integration">Cloud Integration</a>
                <ul>
                  <li><a href="index.html#amazon-web-services">Amazon Web Services</a></li>
                </ul>
              </li>
              <li><a href="index.html#introduction">Introduction</a>
                <ul>
                  <li><a href="index.html#vernacular">Vernacular</a></li>
                  <li><a href="index.html#directory-structure">Directory structure</a></li>
                </ul>
              </li>
              <li><a href="index.html#attributes">Attributes</a>
                <ul>
                  <li><a href="index.html#attribute-precedence">Attribute Precedence</a></li>
                  <li><a href="index.html#cascading-attributes">Cascading Attributes</a></li>
                  <li><a href="index.html#@networks-object">@networks object</a></li>
                  <li><a href="index.html#@server-object">@server object</a></li>
                  <li><a href="index.html#attribute-functions">Attribute Functions</a></li>
                  <li><a href="index.html#calculated-attributes">Calculated Attributes</a></li>
                </ul>
              </li>
              <li><a href="index.html#resources">Resources</a>
                <ul>
                </ul>
              </li>
              <li><a href="index.html#scripts">Scripts</a>
                <ul>
                  <li><a href="index.html#defining-servers">Defining Servers</a></li>
                  <li><a href="index.html#importing-code">Importing Code</a></li>
                  <li><a href="index.html#asynchronous-flow-control">Asynchronous Flow Control</a></li>
                  <li><a href="index.html#cryptography">Cryptography</a></li>
                  <li><a href="index.html#console-debugging">Console Debugging</a></li>
                  <li><a href="index.html#interactive-debugging">Interactive Debugging</a></li>
                  <li><a href="index.html#test-provisioning">Test Provisioning</a></li>
                  <li><a href="index.html#integration-testing">Integration Testing</a></li>
                  <li><a href="index.html#jobs">Jobs</a></li>
                </ul>
              </li>
              <li><a href="index.html#common-resources">Common Resources</a>
                <ul>
                  <li><a href="index.html#@execute()">@execute()</a></li>
                  <li><a href="index.html#@package-update()">@package_update()</a></li>
                  <li><a href="index.html#@install()">@install()</a></li>
                  <li><a href="index.html#@uninstall()">@uninstall()</a></li>
                  <li><a href="index.html#@directory()">@directory()</a></li>
                  <li><a href="index.html#@chown()">@chown()</a></li>
                  <li><a href="index.html#@chmod()">@chmod()</a></li>
                  <li><a href="index.html#@template()">@template()</a></li>
                  <li><a href="index.html#@upload()">@upload()</a></li>
                  <li><a href="index.html#@download()">@download()</a></li>
                  <li><a href="index.html#@link()">@link()</a></li>
                  <li><a href="index.html#@remote-file-exists()">@remote_file_exists()</a></li>
                  <li><a href="index.html#@append-line-to-file()">@append_line_to_file()</a></li>
                  <li><a href="index.html#@replace-line-in-file()">@replace_line_in_file()</a></li>
                  <li><a href="index.html#@user()">@user()</a></li>
                  <li><a href="index.html#@group()">@group()</a></li>
                  <li><a href="index.html#@deploy()">@deploy()</a></li>
                  <li><a href="index.html#@reboot()">@reboot()</a></li>
                </ul>
              </li>
              <li><a href="index.html#third-party-resources">Third-Party Resources</a>
                <ul>
                </ul>
              </li>
              <li><a href="index.html#contributing">Contributing</a>
                <ul>
                  <li><a href="index.html#issuing-a-pull-request">Issuing a Pull Request</a></li>
                </ul>
              </li>
            </ol>
          </div>
        </div>
      </aside>
      <footer>
        <div class="wrapper">
          <div class="left">
            <p>This documentation is licensed <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-Share Alike 3.0</a></p>
            <p>"Borg" is a service mark of <a href="http://smullindesign.com">Smullin Design</a>.</p>
          </div>
          <div class="right"><a href="index.html#top">Back to top &uarr;</a></div>
          <div class="clear"></div>
        </div>
      </footer>
    </div>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Rambla:400,700|Source+Sans+Pro:400,600">
    <link rel="stylesheet" href="stylesheets/monokai_sublime.css">
    <script src="behaviors/highlight.pack.js"></script>
    <script>
      hljs.initHighlightingOnLoad();
      
      
    </script>
  </body>
</html>